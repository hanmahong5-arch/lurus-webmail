# 数据库初始化 Job
# 在现有 CNPG lurus-pg 中创建 kurrier 数据库和所需角色
apiVersion: batch/v1
kind: Job
metadata:
  name: kurrier-db-init
  namespace: kurrier
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: db-init
        image: postgres:15-alpine
        env:
        - name: PGHOST
          value: "lurus-pg-rw.database.svc.cluster.local"
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: "postgres"
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: kurrier-secrets
              key: POSTGRES_PASSWORD
        - name: RLS_CLIENT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kurrier-secrets
              key: RLS_CLIENT_PASSWORD
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Creating kurrier database..."
          psql -c "CREATE DATABASE kurrier;" || echo "Database may already exist"

          echo "Creating roles..."
          psql -d kurrier -c "
            -- Create roles if not exist
            DO \$\$
            BEGIN
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'anon') THEN
                CREATE ROLE anon NOLOGIN;
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'authenticated') THEN
                CREATE ROLE authenticated NOLOGIN;
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'service_role') THEN
                CREATE ROLE service_role NOLOGIN;
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'authenticator') THEN
                CREATE ROLE authenticator LOGIN PASSWORD '${PGPASSWORD}';
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'supabase_auth_admin') THEN
                CREATE ROLE supabase_auth_admin LOGIN PASSWORD '${PGPASSWORD}';
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'supabase_storage_admin') THEN
                CREATE ROLE supabase_storage_admin LOGIN PASSWORD '${PGPASSWORD}';
              END IF;
              IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'rls_client') THEN
                CREATE ROLE rls_client LOGIN PASSWORD '${RLS_CLIENT_PASSWORD}';
              END IF;
            END
            \$\$;

            -- Grant permissions
            GRANT anon, authenticated, service_role TO authenticator;
            GRANT ALL ON DATABASE kurrier TO supabase_auth_admin;
            GRANT ALL ON DATABASE kurrier TO supabase_storage_admin;
            GRANT ALL ON DATABASE kurrier TO rls_client;

            -- Create schemas
            CREATE SCHEMA IF NOT EXISTS auth;
            CREATE SCHEMA IF NOT EXISTS storage;
            CREATE SCHEMA IF NOT EXISTS graphql_public;

            -- Grant schema permissions
            GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
            GRANT USAGE ON SCHEMA auth TO supabase_auth_admin;
            GRANT USAGE ON SCHEMA storage TO supabase_storage_admin;
            GRANT ALL ON SCHEMA auth TO supabase_auth_admin;
            GRANT ALL ON SCHEMA storage TO supabase_storage_admin;
          "

          echo "Database initialization complete!"
